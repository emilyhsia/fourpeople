<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
   <!-- <link rel="shortcut icon" href="../../docs-assets/ico/favicon.png"> TODO -->

    <title>Title</title>

    <!-- Bootstrap core CSS -->
    <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
	<link href="bootstrap/css/bootstrap-theme.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
		<!-- filled in by main.js on every page -->
    </div>

    <div class="container">

      <div class="starter-template">
        <h1>Testing File API</h1>
      </div>
	  <div id="holder"></div>

    </div><!-- /.container -->

	<div class="container" id="footer">
		<hr>
		<!-- filled in by main.js on every page -->
	</div>
	
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.10.2.min.js"></script>
	<!-- load local version of jQuery if cdn fails -->
	<script>window.jQuery || document.write('<script src="js/jquery-1.10.2.min.js">\x3C/script>')</script>
    <script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/main.js"></script>
	
	<script type="text/javascript">
		$(".starter-template").append("jQuery ready");
		var fileSystem;
		window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;

		// request quota (instead of just file system) for persistent data storage
		window.webkitStorageInfo.requestQuota(PERSISTENT, 5*1024*1024, 
				function(grantedBytes) {
				  window.requestFileSystem(PERSISTENT, grantedBytes, onInitFs, errorHandler);
				}, function(e) {
				  console.log('Error', e);
				});
		
		/** On initialize file system **/
		function onInitFs(fs) {
			fileSystem = fs;
			console.log("Sucessfully requested 5MB of persistent file storage; file system: " + fs.name);
			
			// create a file
			// create: true = creates if doesn't exist, throws error if does
			// 		   false = simply fetch and return
			// exclusive: true = returns error if file already exists with create:true
			fileSystem.root.getFile('test.txt', {create: false}, 
				function(fileEntry) {

					// Create a FileWriter object for our FileEntry (log.txt).
					fileEntry.createWriter(function(fileWriter) {
					  //to append
					  //fileWriter.seek(fileWriter.length);
					  
					  fileWriter.onwriteend = function(e) {
						console.log('Write completed.');
					  };

					  fileWriter.onerror = function(e) {
						console.log('Write failed: ' + e.toString());
					  };

					  // Create a new Blob and write it to log.txt.
					  var blob = new Blob(['Hello world!'], {type: 'text/plain'});

					  fileWriter.write(blob);

					}, errorHandler);

				  }, errorHandler);

			// read stuff from file
			fileSystem.root.getFile('test.txt', {}, function(fileEntry) {

				// Get a File object representing the file,
				// then use FileReader to read its contents.
				fileEntry.file(function(file) {
				   var reader = new FileReader();

				   reader.onloadend = function(e) {
					 var txtArea = document.createElement('textarea');
					 txtArea.value = this.result;
					 document.body.appendChild(txtArea);
				   };

				   reader.readAsText(file);
				}, errorHandler);

			  }, errorHandler);
		}
		
		/** Error handler function **/
		function errorHandler(e) {
		  var msg = '';

		  switch (e.code) {
			case FileError.QUOTA_EXCEEDED_ERR:
			  msg = 'QUOTA_EXCEEDED_ERR';
			  break;
			case FileError.NOT_FOUND_ERR:
			  msg = 'NOT_FOUND_ERR';
			  break;
			case FileError.SECURITY_ERR:
			  msg = 'SECURITY_ERR';
			  break;
			case FileError.INVALID_MODIFICATION_ERR:
			  msg = 'INVALID_MODIFICATION_ERR';
			  break;
			case FileError.INVALID_STATE_ERR:
			  msg = 'INVALID_STATE_ERR';
			  break;
			default:
			  msg = 'Unknown Error';
			  break;
		  };

		  console.log('Error: ' + msg);
		  console.log(e);
		}
	</script>
  </body>
</html>